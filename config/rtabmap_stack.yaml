# bringup_dir/config/rtabmap_stack.yaml
#
# Default parameters converted from the example launch:
# - lidar_deskewing
# - point_cloud_assembler
# - icp_odometry
# - rtabmap (mapping)
# - rtabmap_viz
#
# Override any of these at launch by passing parameters=[{...}] to specific Nodes.

lidar_deskewing:
  ros__parameters:
    use_sim_time: false
    fixed_frame_id: ""            # If empty, launch can compute one from IMU or odom
    wait_for_transform: 0.2
    slerp: true                   # Fast interpolation between scan ends

point_cloud_assembler:
  ros__parameters:
    use_sim_time: false
    # Set one of these: assembling_time (sec) OR max_cloud (#clouds)
    assembling_time: 1.0          # 1.0 s window like the example
    fixed_frame_id: ""            # If set, subscribes to odom TF with that fixed frame

icp_odometry:
  ros__parameters:
    use_sim_time: false
    # Frames/TF
    odom_frame_id: icp_odom
    frame_id: base_link           # Typically the robot base frame
    guess_frame_id: ""            # Can be set to a stabilized fixed frame from IMU
    publish_tf: true
    wait_imu_to_init: true
    expected_update_rate: 15.0    # Slightly higher than scan rate

    # General ROS IO
    approx_sync: false
    wait_for_transform: 0.2

    # Odometry tuning (from example)
    Odom/ScanKeyFrameThr: "0.4"
    OdomF2M/ScanSubtractRadius: "0.1"     # Will be overridden by voxel_size if desired
    OdomF2M/ScanMaxSize: "15000"
    OdomF2M/BundleAdjustment: "false"
    Icp/CorrespondenceRatio: "0.01"

    # ICP settings (shared with mapping in example)
    Icp/PointToPlane: "true"
    Icp/Iterations: "10"
    Icp/VoxelSize: "0.1"                 # Example default; override per environment
    Icp/Epsilon: "0.001"
    Icp/PointToPlaneK: "20"
    Icp/PointToPlaneRadius: "0"
    Icp/MaxTranslation: "3"
    Icp/MaxCorrespondenceDistance: "1.0" # ~ voxel_size * 10, see example guideline
    Icp/Strategy: "1"
    Icp/OutlierRatio: "0.7"

rtabmap:
  ros__parameters:
    use_sim_time: false

    # Subscriptions (LiDAR-only mapping)
    subscribe_depth: false
    subscribe_rgb: false
    subscribe_scan: false
    subscribe_scan_cloud: true
    subscribe_odom_info: true       # True when using internal ICP odom; set false if external odom frame provided
    approx_sync: false
    wait_for_transform: 0.2
    odom_sensor_sync: true          # Adjusts camera pose if used, harmless for LiDAR-only

    # Frames (odom_frame_id left empty when rtabmap computes map->odom TF)
    frame_id: base_link
    odom_frame_id: ""               # Empty lets RTAB-Map compute map->odom if odom TF is already published
    map_frame_id: map
    publish_tf: true

    # SLAM mode
    Mem/IncrementalMemory: "true"
    Mem/InitWMWithAllNodes: "false"
    Mem/NotLinkedNodesKept: "false"
    Mem/STMSize: "30"

    # ICP-only registration
    Reg/Strategy: "1"
    Reg/Force3DoF: "true"           # For wheeled robot planar motion

    # LiDAR loop closure settings used in example
    RGBD/ProximityMaxGraphDepth: "0"
    RGBD/ProximityPathMaxNeighbors: "1"
    RGBD/AngularUpdate: "0.05"
    RGBD/LinearUpdate: "0.05"

    # Detection rate: 0 in example (rate set by assembled window); set to 0..N as desired
    Rtabmap/DetectionRate: "0"

    # Grid and occupancy
    RGBD/CreateOccupancyGrid: "false"
    Grid/3D: "true"
    Grid/Sensor: "1"                # Build grid from cloud projection for LiDAR pipelines
    Grid/CellSize: "0.10"
    Grid/RangeMin: "0.1"
    Grid/RangeMax: "20.0"
    Grid/MaxGroundHeight: "0.2"
    Grid/MaxObstacleHeight: "2.0"
    Grid/MaxGroundAngle: "45"

    # ICP sharing (same as odom in example)
    Icp/CorrespondenceRatio: "0.2"  # Will be overridden via launch if needed
    Icp/PointToPlane: "true"
    Icp/Iterations: "10"
    Icp/VoxelSize: "0.1"
    Icp/Epsilon: "0.001"
    Icp/PointToPlaneK: "20"
    Icp/PointToPlaneRadius: "0"
    Icp/MaxTranslation: "3"
    Icp/MaxCorrespondenceDistance: "1.0"
    Icp/Strategy: "1"
    Icp/OutlierRatio: "0.7"

    # Database location
    Rtabmap/DatabasePath: "/home/deanjeggs/new_ros2_ws/src/mpcc/maps/slam_session.db"

rtabmap_viz:
  ros__parameters:
    use_sim_time: false
    frame_id: base_link
    # Typically minimal parameters are needed; viz will follow rtabmap namespace
